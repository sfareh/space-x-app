"use strict";
/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.execute = void 0;
const architect_1 = require("@angular-devkit/architect");
const core_1 = require("@angular-devkit/core");
const browserSync = __importStar(require("browser-sync"));
const http_proxy_middleware_1 = require("http-proxy-middleware");
const path_1 = require("path");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const url = __importStar(require("url"));
const utils_1 = require("./utils");
/** Log messages to ignore and not rely to the logger */
const IGNORED_STDOUT_MESSAGES = [
    'server listening on',
    'Angular is running in development mode. Call enableProdMode() to enable production mode.',
];
function execute(options, context) {
    const browserTarget = (0, architect_1.targetFromTargetString)(options.browserTarget);
    const serverTarget = (0, architect_1.targetFromTargetString)(options.serverTarget);
    const getBaseUrl = (bs) => `${bs.getOption('scheme')}://${bs.getOption('host')}:${bs.getOption('port')}`;
    const browserTargetRun = context.scheduleTarget(browserTarget, {
        serviceWorker: false,
        watch: true,
        progress: options.progress,
    });
    const serverTargetRun = context.scheduleTarget(serverTarget, {
        watch: true,
        progress: options.progress,
    });
    const bsInstance = browserSync.create();
    context.logger.error(core_1.tags.stripIndents `
  ****************************************************************************************
  This is a simple server for use in testing or debugging Angular applications locally.
  It hasn't been reviewed for security issues.

  DON'T USE IT FOR PRODUCTION!
  ****************************************************************************************
 `);
    return (0, rxjs_1.zip)(browserTargetRun, serverTargetRun, (0, utils_1.getAvailablePort)()).pipe((0, operators_1.switchMap)(([br, sr, nodeServerPort]) => {
        return (0, rxjs_1.combineLatest)([br.output, sr.output]).pipe(
        // This is needed so that if both server and browser emit close to each other
        // we only emit once. This typically happens on the first build.
        (0, operators_1.debounceTime)(120), (0, operators_1.switchMap)(([b, s]) => {
            if (!s.success || !b.success) {
                return (0, rxjs_1.of)([b, s]);
            }
            return startNodeServer(s, nodeServerPort, context.logger, !!options.inspect).pipe((0, operators_1.mapTo)([b, s]), (0, operators_1.catchError)((err) => {
                context.logger.error(`A server error has occurred.\n${mapErrorToMessage(err)}`);
                return rxjs_1.EMPTY;
            }));
        }), (0, operators_1.map)(([b, s]) => [
            {
                success: b.success && s.success,
                error: b.error || s.error,
            },
            nodeServerPort,
        ]), (0, operators_1.tap)(([builderOutput]) => {
            if (builderOutput.success) {
                context.logger.info('\nCompiled successfully.');
            }
        }), (0, operators_1.debounce)(([builderOutput]) => builderOutput.success && !options.inspect
            ? (0, utils_1.waitUntilServerIsListening)(nodeServerPort)
            : rxjs_1.EMPTY));
    }), (0, operators_1.concatMap)(([builderOutput, nodeServerPort]) => {
        if (!builderOutput.success) {
            return (0, rxjs_1.of)(builderOutput);
        }
        if (bsInstance.active) {
            bsInstance.reload();
            return (0, rxjs_1.of)(builderOutput);
        }
        else {
            return (0, rxjs_1.from)(initBrowserSync(bsInstance, nodeServerPort, options, context)).pipe((0, operators_1.tap)((bs) => {
                const baseUrl = getBaseUrl(bs);
                context.logger.info(core_1.tags.oneLine `
                **
                Angular Universal Live Development Server is listening on ${baseUrl},
                open your browser on ${baseUrl}
                **
              `);
            }), (0, operators_1.mapTo)(builderOutput));
        }
    }), (0, operators_1.map)((builderOutput) => ({
        success: builderOutput.success,
        error: builderOutput.error,
        baseUrl: bsInstance && getBaseUrl(bsInstance),
    })), (0, operators_1.finalize)(() => {
        if (bsInstance) {
            bsInstance.exit();
            bsInstance.cleanup();
        }
    }), (0, operators_1.catchError)((error) => (0, rxjs_1.of)({
        success: false,
        error: mapErrorToMessage(error),
    })));
}
exports.execute = execute;
function startNodeServer(serverOutput, port, logger, inspectMode = false) {
    const outputPath = serverOutput.outputPath;
    const path = (0, path_1.join)(outputPath, 'main.js');
    const env = { ...process.env, PORT: '' + port };
    const args = [`"${path}"`];
    if (inspectMode) {
        args.unshift('--inspect-brk');
    }
    return (0, rxjs_1.of)(null).pipe((0, operators_1.delay)(0), // Avoid EADDRINUSE error since it will cause the kill event to be finish.
    (0, operators_1.switchMap)(() => (0, utils_1.spawnAsObservable)('node', args, { env, shell: true })), (0, operators_1.tap)(({ stderr, stdout }) => {
        if (stderr) {
            logger.error(stderr);
        }
        if (stdout && !IGNORED_STDOUT_MESSAGES.some((x) => stdout.includes(x))) {
            logger.info(stdout);
        }
    }), (0, operators_1.ignoreElements)(), 
    // Emit a signal after the process has been started
    (0, operators_1.startWith)(undefined));
}
async function initBrowserSync(browserSyncInstance, nodeServerPort, options, context) {
    if (browserSyncInstance.active) {
        return browserSyncInstance;
    }
    const { port: browserSyncPort, open, host, publicHost, proxyConfig } = options;
    const bsPort = browserSyncPort || (await (0, utils_1.getAvailablePort)());
    const bsOptions = {
        proxy: {
            target: `localhost:${nodeServerPort}`,
            proxyOptions: {
                xfwd: true,
            },
            proxyRes: [
                (proxyRes) => {
                    if ('headers' in proxyRes) {
                        proxyRes.headers['cache-control'] = undefined;
                    }
                },
            ],
            // proxyOptions is not in the typings
        },
        host,
        port: bsPort,
        ui: false,
        server: false,
        notify: false,
        ghostMode: false,
        logLevel: 'silent',
        open,
        https: getSslConfig(context.workspaceRoot, options),
    };
    const publicHostNormalized = publicHost && publicHost.endsWith('/')
        ? publicHost.substring(0, publicHost.length - 1)
        : publicHost;
    if (publicHostNormalized) {
        const { protocol, hostname, port, pathname } = url.parse(publicHostNormalized);
        const defaultSocketIoPath = '/browser-sync/socket.io';
        const defaultNamespace = '/browser-sync';
        const hasPathname = !!(pathname && pathname !== '/');
        const namespace = hasPathname ? pathname + defaultNamespace : defaultNamespace;
        const path = hasPathname ? pathname + defaultSocketIoPath : defaultSocketIoPath;
        bsOptions.socket = {
            namespace,
            path,
            domain: url.format({
                protocol,
                hostname,
                port,
            }),
        };
        // When having a pathname we also need to create a reverse proxy because socket.io
        // will be listening on: 'http://localhost:4200/ssr/browser-sync/socket.io'
        // However users will typically have a reverse proxy that will redirect all matching requests
        // ex: http://testinghost.com/ssr -> http://localhost:4200 which will result in a 404.
        if (hasPathname) {
            // Remove leading slash
            // eslint-disable-next-line @typescript-eslint/no-unused-expressions
            (bsOptions.scriptPath = (p) => p.substring(1)),
                (bsOptions.middleware = [
                    (0, http_proxy_middleware_1.createProxyMiddleware)(defaultSocketIoPath, {
                        target: url.format({
                            protocol: 'http',
                            hostname: host,
                            port: bsPort,
                            pathname: path,
                        }),
                        ws: true,
                        logLevel: 'silent',
                    }),
                ]);
        }
    }
    if (proxyConfig) {
        if (!bsOptions.middleware) {
            bsOptions.middleware = [];
        }
        else if (!Array.isArray(bsOptions.middleware)) {
            bsOptions.middleware = [bsOptions.middleware];
        }
        bsOptions.middleware = [
            ...bsOptions.middleware,
            ...getProxyConfig(context.workspaceRoot, proxyConfig),
        ];
    }
    return new Promise((resolve, reject) => {
        browserSyncInstance.init(bsOptions, (error, bs) => {
            if (error) {
                reject(error);
            }
            else {
                resolve(bs);
            }
        });
    });
}
function mapErrorToMessage(error) {
    if (error instanceof Error) {
        return error.message;
    }
    if (typeof error === 'string') {
        return error;
    }
    return '';
}
function getSslConfig(root, options) {
    const { ssl, sslCert, sslKey } = options;
    if (ssl && sslCert && sslKey) {
        return {
            key: (0, path_1.resolve)(root, sslKey),
            cert: (0, path_1.resolve)(root, sslCert),
        };
    }
    return ssl;
}
function getProxyConfig(root, proxyConfig) {
    const proxyPath = (0, path_1.resolve)(root, proxyConfig);
    let proxySettings;
    try {
        proxySettings = require(proxyPath);
    }
    catch (error) {
        if (error.code === 'MODULE_NOT_FOUND') {
            throw new Error(`Proxy config file ${proxyPath} does not exist.`);
        }
        throw error;
    }
    const proxies = Array.isArray(proxySettings) ? proxySettings : [proxySettings];
    const createdProxies = [];
    for (const proxy of proxies) {
        for (const [key, context] of Object.entries(proxy)) {
            if (typeof key === 'string') {
                createdProxies.push((0, http_proxy_middleware_1.createProxyMiddleware)(key.replace(/^\*$/, '**').replace(/\/\*$/, ''), context));
            }
            else {
                createdProxies.push((0, http_proxy_middleware_1.createProxyMiddleware)(key, context));
            }
        }
    }
    return createdProxies;
}
exports.default = (0, architect_1.createBuilder)(execute);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9tb2R1bGVzL2J1aWxkZXJzL3NyYy9zc3ItZGV2LXNlcnZlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7OztHQU1HOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUgseURBS21DO0FBQ25DLCtDQUEyRDtBQUMzRCwwREFBNEM7QUFDNUMsaUVBQThEO0FBQzlELCtCQUFvRDtBQUNwRCwrQkFBdUU7QUFDdkUsOENBYXdCO0FBQ3hCLHlDQUEyQjtBQUczQixtQ0FBMEY7QUFFMUYsd0RBQXdEO0FBQ3hELE1BQU0sdUJBQXVCLEdBQUc7SUFDOUIscUJBQXFCO0lBQ3JCLDBGQUEwRjtDQUMzRixDQUFDO0FBT0YsU0FBZ0IsT0FBTyxDQUNyQixPQUFtQyxFQUNuQyxPQUF1QjtJQUV2QixNQUFNLGFBQWEsR0FBRyxJQUFBLGtDQUFzQixFQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNwRSxNQUFNLFlBQVksR0FBRyxJQUFBLGtDQUFzQixFQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNsRSxNQUFNLFVBQVUsR0FBRyxDQUFDLEVBQW1DLEVBQUUsRUFBRSxDQUN6RCxHQUFHLEVBQUUsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7SUFDaEYsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRTtRQUM3RCxhQUFhLEVBQUUsS0FBSztRQUNwQixLQUFLLEVBQUUsSUFBSTtRQUNYLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtLQUMzQixDQUFDLENBQUM7SUFFSCxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLFlBQVksRUFBRTtRQUMz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R0FBRyxFQUFFLE9BQU8sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDbEQsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLEVBQUU7Z0JBQzNCLGNBQWMsQ0FBQyxJQUFJLENBQ2pCLElBQUEsNkNBQXFCLEVBQ25CLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLEVBQzlDLE9BQWMsQ0FDa0IsQ0FDbkMsQ0FBQzthQUNIO2lCQUFNO2dCQUNMLGNBQWMsQ0FBQyxJQUFJLENBQ2pCLElBQUEsNkNBQXFCLEVBQUMsR0FBRyxFQUFFLE9BQWMsQ0FBa0MsQ0FDNUUsQ0FBQzthQUNIO1NBQ0Y7S0FDRjtJQUVELE9BQU8sY0FBYyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxrQkFBZSxJQUFBLHlCQUFhLEVBQTRDLE9BQU8sQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7XG4gIEJ1aWxkZXJDb250ZXh0LFxuICBCdWlsZGVyT3V0cHV0LFxuICBjcmVhdGVCdWlsZGVyLFxuICB0YXJnZXRGcm9tVGFyZ2V0U3RyaW5nLFxufSBmcm9tICdAYW5ndWxhci1kZXZraXQvYXJjaGl0ZWN0JztcbmltcG9ydCB7IGpzb24sIGxvZ2dpbmcsIHRhZ3MgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZSc7XG5pbXBvcnQgKiBhcyBicm93c2VyU3luYyBmcm9tICdicm93c2VyLXN5bmMnO1xuaW1wb3J0IHsgY3JlYXRlUHJveHlNaWRkbGV3YXJlIH0gZnJvbSAnaHR0cC1wcm94eS1taWRkbGV3YXJlJztcbmltcG9ydCB7IGpvaW4sIHJlc29sdmUgYXMgcGF0aFJlc29sdmUgfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlLCBjb21iaW5lTGF0ZXN0LCBmcm9tLCBvZiwgemlwIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBjYXRjaEVycm9yLFxuICBjb25jYXRNYXAsXG4gIGRlYm91bmNlLFxuICBkZWJvdW5jZVRpbWUsXG4gIGRlbGF5LFxuICBmaW5hbGl6ZSxcbiAgaWdub3JlRWxlbWVudHMsXG4gIG1hcCxcbiAgbWFwVG8sXG4gIHN0YXJ0V2l0aCxcbiAgc3dpdGNoTWFwLFxuICB0YXAsXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCAqIGFzIHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IHsgU2NoZW1hIH0gZnJvbSAnLi9zY2hlbWEnO1xuXG5pbXBvcnQgeyBnZXRBdmFpbGFibGVQb3J0LCBzcGF3bkFzT2JzZXJ2YWJsZSwgd2FpdFVudGlsU2VydmVySXNMaXN0ZW5pbmcgfSBmcm9tICcuL3V0aWxzJztcblxuLyoqIExvZyBtZXNzYWdlcyB0byBpZ25vcmUgYW5kIG5vdCByZWx5IHRvIHRoZSBsb2dnZXIgKi9cbmNvbnN0IElHTk9SRURfU1RET1VUX01FU1NBR0VTID0gW1xuICAnc2VydmVyIGxpc3RlbmluZyBvbicsXG4gICdBbmd1bGFyIGlzIHJ1bm5pbmcgaW4gZGV2ZWxvcG1lbnQgbW9kZS4gQ2FsbCBlbmFibGVQcm9kTW9kZSgpIHRvIGVuYWJsZSBwcm9kdWN0aW9uIG1vZGUuJyxcbl07XG5cbmV4cG9ydCB0eXBlIFNTUkRldlNlcnZlckJ1aWxkZXJPcHRpb25zID0gU2NoZW1hICYganNvbi5Kc29uT2JqZWN0O1xuZXhwb3J0IHR5cGUgU1NSRGV2U2VydmVyQnVpbGRlck91dHB1dCA9IEJ1aWxkZXJPdXRwdXQgJiB7XG4gIGJhc2VVcmw/OiBzdHJpbmc7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gZXhlY3V0ZShcbiAgb3B0aW9uczogU1NSRGV2U2VydmVyQnVpbGRlck9wdGlvbnMsXG4gIGNvbnRleHQ6IEJ1aWxkZXJDb250ZXh0LFxuKTogT2JzZXJ2YWJsZTxTU1JEZXZTZXJ2ZXJCdWlsZGVyT3V0cHV0PiB7XG4gIGNvbnN0IGJyb3dzZXJUYXJnZXQgPSB0YXJnZXRGcm9tVGFyZ2V0U3RyaW5nKG9wdGlvbnMuYnJvd3NlclRhcmdldCk7XG4gIGNvbnN0IHNlcnZlclRhcmdldCA9IHRhcmdldEZyb21UYXJnZXRTdHJpbmcob3B0aW9ucy5zZXJ2ZXJUYXJnZXQpO1xuICBjb25zdCBnZXRCYXNlVXJsID0gKGJzOiBicm93c2VyU3luYy5Ccm93c2VyU3luY0luc3RhbmNlKSA9PlxuICAgIGAke2JzLmdldE9wdGlvbignc2NoZW1lJyl9Oi8vJHticy5nZXRPcHRpb24oJ2hvc3QnKX06JHticy5nZXRPcHRpb24oJ3BvcnQnKX1gO1xuICBjb25zdCBicm93c2VyVGFyZ2V0UnVuID0gY29udGV4dC5zY2hlZHVsZVRhcmdldChicm93c2VyVGFyZ2V0LCB7XG4gICAgc2VydmljZVdvcmtlcjogZmFsc2UsXG4gICAgd2F0Y2g6IHRydWUsXG4gICAgcHJvZ3Jlc3M6IG9wdGlvbnMucHJvZ3Jlc3MsXG4gIH0pO1xuXG4gIGNvbnN0IHNlcnZlclRhcmdldFJ1biA9IGNvbnRleHQuc2NoZWR1bGVUYXJnZXQoc2VydmVyVGFyZ2V0LCB7XG4gICAgd2F0Y2g6IHRydWUsXG4gICAgcHJvZ3Jlc3M6IG9wdGlvbnMucHJvZ3Jlc3MsXG4gIH0pO1xuXG4gIGNvbnN0IGJzSW5zdGFuY2UgPSBicm93c2VyU3luYy5jcmVhdGUoKTtcblxuICBjb250ZXh0LmxvZ2dlci5lcnJvcih0YWdzLnN0cmlwSW5kZW50c2BcbiAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICBUaGlzIGlzIGEgc2ltcGxlIHNlcnZlciBmb3IgdXNlIGluIHRlc3Rpbmcgb3IgZGVidWdnaW5nIEFuZ3VsYXIgYXBwbGljYXRpb25zIGxvY2FsbHkuXG4gIEl0IGhhc24ndCBiZWVuIHJldmlld2VkIGZvciBzZWN1cml0eSBpc3N1ZXMuXG5cbiAgRE9OJ1QgVVNFIElUIEZPUiBQUk9EVUNUSU9OIVxuICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXG4gYCk7XG5cbiAgcmV0dXJuIHppcChicm93c2VyVGFyZ2V0UnVuLCBzZXJ2ZXJUYXJnZXRSdW4sIGdldEF2YWlsYWJsZVBvcnQoKSkucGlwZShcbiAgICBzd2l0Y2hNYXAoKFticiwgc3IsIG5vZGVTZXJ2ZXJQb3J0XSkgPT4ge1xuICAgICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW2JyLm91dHB1dCwgc3Iub3V0cHV0XSkucGlwZShcbiAgICAgICAgLy8gVGhpcyBpcyBuZWVkZWQgc28gdGhhdCBpZiBib3RoIHNlcnZlciBhbmQgYnJvd3NlciBlbWl0IGNsb3NlIHRvIGVhY2ggb3RoZXJcbiAgICAgICAgLy8gd2Ugb25seSBlbWl0IG9uY2UuIFRoaXMgdHlwaWNhbGx5IGhhcHBlbnMgb24gdGhlIGZpcnN0IGJ1aWxkLlxuICAgICAgICBkZWJvdW5jZVRpbWUoMTIwKSxcbiAgICAgICAgc3dpdGNoTWFwKChbYiwgc10pID0+IHtcbiAgICAgICAgICBpZiAoIXMuc3VjY2VzcyB8fCAhYi5zdWNjZXNzKSB7XG4gICAgICAgICAgICByZXR1cm4gb2YoW2IsIHNdKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gc3RhcnROb2RlU2VydmVyKHMsIG5vZGVTZXJ2ZXJQb3J0LCBjb250ZXh0LmxvZ2dlciwgISFvcHRpb25zLmluc3BlY3QpLnBpcGUoXG4gICAgICAgICAgICBtYXBUbyhbYiwgc10pLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmVycm9yKGBBIHNlcnZlciBlcnJvciBoYXMgb2NjdXJyZWQuXFxuJHttYXBFcnJvclRvTWVzc2FnZShlcnIpfWApO1xuXG4gICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICk7XG4gICAgICAgIH0pLFxuICAgICAgICBtYXAoXG4gICAgICAgICAgKFtiLCBzXSkgPT5cbiAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGIuc3VjY2VzcyAmJiBzLnN1Y2Nlc3MsXG4gICAgICAgICAgICAgICAgZXJyb3I6IGIuZXJyb3IgfHwgcy5lcnJvcixcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgbm9kZVNlcnZlclBvcnQsXG4gICAgICAgICAgICBdIGFzIFtTU1JEZXZTZXJ2ZXJCdWlsZGVyT3V0cHV0LCBudW1iZXJdLFxuICAgICAgICApLFxuICAgICAgICB0YXAoKFtidWlsZGVyT3V0cHV0XSkgPT4ge1xuICAgICAgICAgIGlmIChidWlsZGVyT3V0cHV0LnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ1xcbkNvbXBpbGVkIHN1Y2Nlc3NmdWxseS4nKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICBkZWJvdW5jZSgoW2J1aWxkZXJPdXRwdXRdKSA9PlxuICAgICAgICAgIGJ1aWxkZXJPdXRwdXQuc3VjY2VzcyAmJiAhb3B0aW9ucy5pbnNwZWN0XG4gICAgICAgICAgICA/IHdhaXRVbnRpbFNlcnZlcklzTGlzdGVuaW5nKG5vZGVTZXJ2ZXJQb3J0KVxuICAgICAgICAgICAgOiBFTVBUWSxcbiAgICAgICAgKSxcbiAgICAgICk7XG4gICAgfSksXG4gICAgY29uY2F0TWFwKChbYnVpbGRlck91dHB1dCwgbm9kZVNlcnZlclBvcnRdKSA9PiB7XG4gICAgICBpZiAoIWJ1aWxkZXJPdXRwdXQuc3VjY2Vzcykge1xuICAgICAgICByZXR1cm4gb2YoYnVpbGRlck91dHB1dCk7XG4gICAgICB9XG5cbiAgICAgIGlmIChic0luc3RhbmNlLmFjdGl2ZSkge1xuICAgICAgICBic0luc3RhbmNlLnJlbG9hZCgpO1xuXG4gICAgICAgIHJldHVybiBvZihidWlsZGVyT3V0cHV0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBmcm9tKGluaXRCcm93c2VyU3luYyhic0luc3RhbmNlLCBub2RlU2VydmVyUG9ydCwgb3B0aW9ucywgY29udGV4dCkpLnBpcGUoXG4gICAgICAgICAgdGFwKChicykgPT4ge1xuICAgICAgICAgICAgY29uc3QgYmFzZVVybCA9IGdldEJhc2VVcmwoYnMpO1xuICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyh0YWdzLm9uZUxpbmVgXG4gICAgICAgICAgICAgICAgKipcbiAgICAgICAgICAgICAgICBBbmd1bGFyIFVuaXZlcnNhbCBMaXZlIERldmVsb3BtZW50IFNlcnZlciBpcyBsaXN0ZW5pbmcgb24gJHtiYXNlVXJsfSxcbiAgICAgICAgICAgICAgICBvcGVuIHlvdXIgYnJvd3NlciBvbiAke2Jhc2VVcmx9XG4gICAgICAgICAgICAgICAgKipcbiAgICAgICAgICAgICAgYCk7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgbWFwVG8oYnVpbGRlck91dHB1dCksXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSksXG4gICAgbWFwKFxuICAgICAgKGJ1aWxkZXJPdXRwdXQpID0+XG4gICAgICAgICh7XG4gICAgICAgICAgc3VjY2VzczogYnVpbGRlck91dHB1dC5zdWNjZXNzLFxuICAgICAgICAgIGVycm9yOiBidWlsZGVyT3V0cHV0LmVycm9yLFxuICAgICAgICAgIGJhc2VVcmw6IGJzSW5zdGFuY2UgJiYgZ2V0QmFzZVVybChic0luc3RhbmNlKSxcbiAgICAgICAgfSBhcyBTU1JEZXZTZXJ2ZXJCdWlsZGVyT3V0cHV0KSxcbiAgICApLFxuICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgIGlmIChic0luc3RhbmNlKSB7XG4gICAgICAgIGJzSW5zdGFuY2UuZXhpdCgpO1xuICAgICAgICBic0luc3RhbmNlLmNsZWFudXAoKTtcbiAgICAgIH1cbiAgICB9KSxcbiAgICBjYXRjaEVycm9yKChlcnJvcikgPT5cbiAgICAgIG9mKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiBtYXBFcnJvclRvTWVzc2FnZShlcnJvciksXG4gICAgICB9KSxcbiAgICApLFxuICApO1xufVxuXG5mdW5jdGlvbiBzdGFydE5vZGVTZXJ2ZXIoXG4gIHNlcnZlck91dHB1dDogQnVpbGRlck91dHB1dCxcbiAgcG9ydDogbnVtYmVyLFxuICBsb2dnZXI6IGxvZ2dpbmcuTG9nZ2VyQXBpLFxuICBpbnNwZWN0TW9kZSA9IGZhbHNlLFxuKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gIGNvbnN0IG91dHB1dFBhdGggPSBzZXJ2ZXJPdXRwdXQub3V0cHV0UGF0aCBhcyBzdHJpbmc7XG4gIGNvbnN0IHBhdGggPSBqb2luKG91dHB1dFBhdGgsICdtYWluLmpzJyk7XG4gIGNvbnN0IGVudiA9IHsgLi4ucHJvY2Vzcy5lbnYsIFBPUlQ6ICcnICsgcG9ydCB9O1xuXG4gIGNvbnN0IGFyZ3MgPSBbYFwiJHtwYXRofVwiYF07XG4gIGlmIChpbnNwZWN0TW9kZSkge1xuICAgIGFyZ3MudW5zaGlmdCgnLS1pbnNwZWN0LWJyaycpO1xuICB9XG5cbiAgcmV0dXJuIG9mKG51bGwpLnBpcGUoXG4gICAgZGVsYXkoMCksIC8vIEF2b2lkIEVBRERSSU5VU0UgZXJyb3Igc2luY2UgaXQgd2lsbCBjYXVzZSB0aGUga2lsbCBldmVudCB0byBiZSBmaW5pc2guXG4gICAgc3dpdGNoTWFwKCgpID0+IHNwYXduQXNPYnNlcnZhYmxlKCdub2RlJywgYXJncywgeyBlbnYsIHNoZWxsOiB0cnVlIH0pKSxcbiAgICB0YXAoKHsgc3RkZXJyLCBzdGRvdXQgfSkgPT4ge1xuICAgICAgaWYgKHN0ZGVycikge1xuICAgICAgICBsb2dnZXIuZXJyb3Ioc3RkZXJyKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHN0ZG91dCAmJiAhSUdOT1JFRF9TVERPVVRfTUVTU0FHRVMuc29tZSgoeCkgPT4gc3Rkb3V0LmluY2x1ZGVzKHgpKSkge1xuICAgICAgICBsb2dnZXIuaW5mbyhzdGRvdXQpO1xuICAgICAgfVxuICAgIH0pLFxuICAgIGlnbm9yZUVsZW1lbnRzKCksXG4gICAgLy8gRW1pdCBhIHNpZ25hbCBhZnRlciB0aGUgcHJvY2VzcyBoYXMgYmVlbiBzdGFydGVkXG4gICAgc3RhcnRXaXRoKHVuZGVmaW5lZCksXG4gICk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXRCcm93c2VyU3luYyhcbiAgYnJvd3NlclN5bmNJbnN0YW5jZTogYnJvd3NlclN5bmMuQnJvd3NlclN5bmNJbnN0YW5jZSxcbiAgbm9kZVNlcnZlclBvcnQ6IG51bWJlcixcbiAgb3B0aW9uczogU1NSRGV2U2VydmVyQnVpbGRlck9wdGlvbnMsXG4gIGNvbnRleHQ6IEJ1aWxkZXJDb250ZXh0LFxuKTogUHJvbWlzZTxicm93c2VyU3luYy5Ccm93c2VyU3luY0luc3RhbmNlPiB7XG4gIGlmIChicm93c2VyU3luY0luc3RhbmNlLmFjdGl2ZSkge1xuICAgIHJldHVybiBicm93c2VyU3luY0luc3RhbmNlO1xuICB9XG5cbiAgY29uc3QgeyBwb3J0OiBicm93c2VyU3luY1BvcnQsIG9wZW4sIGhvc3QsIHB1YmxpY0hvc3QsIHByb3h5Q29uZmlnIH0gPSBvcHRpb25zO1xuICBjb25zdCBic1BvcnQgPSBicm93c2VyU3luY1BvcnQgfHwgKGF3YWl0IGdldEF2YWlsYWJsZVBvcnQoKSk7XG4gIGNvbnN0IGJzT3B0aW9uczogYnJvd3NlclN5bmMuT3B0aW9ucyA9IHtcbiAgICBwcm94eToge1xuICAgICAgdGFyZ2V0OiBgbG9jYWxob3N0OiR7bm9kZVNlcnZlclBvcnR9YCxcbiAgICAgIHByb3h5T3B0aW9uczoge1xuICAgICAgICB4ZndkOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIHByb3h5UmVzOiBbXG4gICAgICAgIChwcm94eVJlcykgPT4ge1xuICAgICAgICAgIGlmICgnaGVhZGVycycgaW4gcHJveHlSZXMpIHtcbiAgICAgICAgICAgIHByb3h5UmVzLmhlYWRlcnNbJ2NhY2hlLWNvbnRyb2wnXSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgLy8gcHJveHlPcHRpb25zIGlzIG5vdCBpbiB0aGUgdHlwaW5nc1xuICAgIH0gYXMgYnJvd3NlclN5bmMuUHJveHlPcHRpb25zICYgeyBwcm94eU9wdGlvbnM6IHsgeGZ3ZDogYm9vbGVhbiB9IH0sXG4gICAgaG9zdCxcbiAgICBwb3J0OiBic1BvcnQsXG4gICAgdWk6IGZhbHNlLFxuICAgIHNlcnZlcjogZmFsc2UsXG4gICAgbm90aWZ5OiBmYWxzZSxcbiAgICBnaG9zdE1vZGU6IGZhbHNlLFxuICAgIGxvZ0xldmVsOiAnc2lsZW50JyxcbiAgICBvcGVuLFxuICAgIGh0dHBzOiBnZXRTc2xDb25maWcoY29udGV4dC53b3Jrc3BhY2VSb290LCBvcHRpb25zKSxcbiAgfTtcblxuICBjb25zdCBwdWJsaWNIb3N0Tm9ybWFsaXplZCA9XG4gICAgcHVibGljSG9zdCAmJiBwdWJsaWNIb3N0LmVuZHNXaXRoKCcvJylcbiAgICAgID8gcHVibGljSG9zdC5zdWJzdHJpbmcoMCwgcHVibGljSG9zdC5sZW5ndGggLSAxKVxuICAgICAgOiBwdWJsaWNIb3N0O1xuXG4gIGlmIChwdWJsaWNIb3N0Tm9ybWFsaXplZCkge1xuICAgIGNvbnN0IHsgcHJvdG9jb2wsIGhvc3RuYW1lLCBwb3J0LCBwYXRobmFtZSB9ID0gdXJsLnBhcnNlKHB1YmxpY0hvc3ROb3JtYWxpemVkKTtcbiAgICBjb25zdCBkZWZhdWx0U29ja2V0SW9QYXRoID0gJy9icm93c2VyLXN5bmMvc29ja2V0LmlvJztcbiAgICBjb25zdCBkZWZhdWx0TmFtZXNwYWNlID0gJy9icm93c2VyLXN5bmMnO1xuICAgIGNvbnN0IGhhc1BhdGhuYW1lID0gISEocGF0aG5hbWUgJiYgcGF0aG5hbWUgIT09ICcvJyk7XG4gICAgY29uc3QgbmFtZXNwYWNlID0gaGFzUGF0aG5hbWUgPyBwYXRobmFtZSArIGRlZmF1bHROYW1lc3BhY2UgOiBkZWZhdWx0TmFtZXNwYWNlO1xuICAgIGNvbnN0IHBhdGggPSBoYXNQYXRobmFtZSA/IHBhdGhuYW1lICsgZGVmYXVsdFNvY2tldElvUGF0aCA6IGRlZmF1bHRTb2NrZXRJb1BhdGg7XG5cbiAgICBic09wdGlvbnMuc29ja2V0ID0ge1xuICAgICAgbmFtZXNwYWNlLFxuICAgICAgcGF0aCxcbiAgICAgIGRvbWFpbjogdXJsLmZvcm1hdCh7XG4gICAgICAgIHByb3RvY29sLFxuICAgICAgICBob3N0bmFtZSxcbiAgICAgICAgcG9ydCxcbiAgICAgIH0pLFxuICAgIH07XG5cbiAgICAvLyBXaGVuIGhhdmluZyBhIHBhdGhuYW1lIHdlIGFsc28gbmVlZCB0byBjcmVhdGUgYSByZXZlcnNlIHByb3h5IGJlY2F1c2Ugc29ja2V0LmlvXG4gICAgLy8gd2lsbCBiZSBsaXN0ZW5pbmcgb246ICdodHRwOi8vbG9jYWxob3N0OjQyMDAvc3NyL2Jyb3dzZXItc3luYy9zb2NrZXQuaW8nXG4gICAgLy8gSG93ZXZlciB1c2VycyB3aWxsIHR5cGljYWxseSBoYXZlIGEgcmV2ZXJzZSBwcm94eSB0aGF0IHdpbGwgcmVkaXJlY3QgYWxsIG1hdGNoaW5nIHJlcXVlc3RzXG4gICAgLy8gZXg6IGh0dHA6Ly90ZXN0aW5naG9zdC5jb20vc3NyIC0+IGh0dHA6Ly9sb2NhbGhvc3Q6NDIwMCB3aGljaCB3aWxsIHJlc3VsdCBpbiBhIDQwNC5cbiAgICBpZiAoaGFzUGF0aG5hbWUpIHtcbiAgICAgIC8vIFJlbW92ZSBsZWFkaW5nIHNsYXNoXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC1leHByZXNzaW9uc1xuICAgICAgKGJzT3B0aW9ucy5zY3JpcHRQYXRoID0gKHApID0+IHAuc3Vic3RyaW5nKDEpKSxcbiAgICAgICAgKGJzT3B0aW9ucy5taWRkbGV3YXJlID0gW1xuICAgICAgICAgIGNyZWF0ZVByb3h5TWlkZGxld2FyZShkZWZhdWx0U29ja2V0SW9QYXRoLCB7XG4gICAgICAgICAgICB0YXJnZXQ6IHVybC5mb3JtYXQoe1xuICAgICAgICAgICAgICBwcm90b2NvbDogJ2h0dHAnLFxuICAgICAgICAgICAgICBob3N0bmFtZTogaG9zdCxcbiAgICAgICAgICAgICAgcG9ydDogYnNQb3J0LFxuICAgICAgICAgICAgICBwYXRobmFtZTogcGF0aCxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgd3M6IHRydWUsXG4gICAgICAgICAgICBsb2dMZXZlbDogJ3NpbGVudCcsXG4gICAgICAgICAgfSkgYXMgYW55LFxuICAgICAgICBdKTtcbiAgICB9XG4gIH1cblxuICBpZiAocHJveHlDb25maWcpIHtcbiAgICBpZiAoIWJzT3B0aW9ucy5taWRkbGV3YXJlKSB7XG4gICAgICBic09wdGlvbnMubWlkZGxld2FyZSA9IFtdO1xuICAgIH0gZWxzZSBpZiAoIUFycmF5LmlzQXJyYXkoYnNPcHRpb25zLm1pZGRsZXdhcmUpKSB7XG4gICAgICBic09wdGlvbnMubWlkZGxld2FyZSA9IFtic09wdGlvbnMubWlkZGxld2FyZV07XG4gICAgfVxuXG4gICAgYnNPcHRpb25zLm1pZGRsZXdhcmUgPSBbXG4gICAgICAuLi5ic09wdGlvbnMubWlkZGxld2FyZSxcbiAgICAgIC4uLmdldFByb3h5Q29uZmlnKGNvbnRleHQud29ya3NwYWNlUm9vdCwgcHJveHlDb25maWcpLFxuICAgIF07XG4gIH1cblxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGJyb3dzZXJTeW5jSW5zdGFuY2UuaW5pdChic09wdGlvbnMsIChlcnJvciwgYnMpID0+IHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzb2x2ZShicyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBtYXBFcnJvclRvTWVzc2FnZShlcnJvcjogdW5rbm93bik6IHN0cmluZyB7XG4gIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgcmV0dXJuIGVycm9yLm1lc3NhZ2U7XG4gIH1cblxuICBpZiAodHlwZW9mIGVycm9yID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBlcnJvcjtcbiAgfVxuXG4gIHJldHVybiAnJztcbn1cblxuZnVuY3Rpb24gZ2V0U3NsQ29uZmlnKFxuICByb290OiBzdHJpbmcsXG4gIG9wdGlvbnM6IFNTUkRldlNlcnZlckJ1aWxkZXJPcHRpb25zLFxuKTogYnJvd3NlclN5bmMuSHR0cHNPcHRpb25zIHwgdW5kZWZpbmVkIHwgYm9vbGVhbiB7XG4gIGNvbnN0IHsgc3NsLCBzc2xDZXJ0LCBzc2xLZXkgfSA9IG9wdGlvbnM7XG4gIGlmIChzc2wgJiYgc3NsQ2VydCAmJiBzc2xLZXkpIHtcbiAgICByZXR1cm4ge1xuICAgICAga2V5OiBwYXRoUmVzb2x2ZShyb290LCBzc2xLZXkpLFxuICAgICAgY2VydDogcGF0aFJlc29sdmUocm9vdCwgc3NsQ2VydCksXG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiBzc2w7XG59XG5cbmZ1bmN0aW9uIGdldFByb3h5Q29uZmlnKHJvb3Q6IHN0cmluZywgcHJveHlDb25maWc6IHN0cmluZyk6IGJyb3dzZXJTeW5jLk1pZGRsZXdhcmVIYW5kbGVyW10ge1xuICBjb25zdCBwcm94eVBhdGggPSBwYXRoUmVzb2x2ZShyb290LCBwcm94eUNvbmZpZyk7XG4gIGxldCBwcm94eVNldHRpbmdzOiBhbnk7XG4gIHRyeSB7XG4gICAgcHJveHlTZXR0aW5ncyA9IHJlcXVpcmUocHJveHlQYXRoKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ01PRFVMRV9OT1RfRk9VTkQnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb3h5IGNvbmZpZyBmaWxlICR7cHJveHlQYXRofSBkb2VzIG5vdCBleGlzdC5gKTtcbiAgICB9XG5cbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuXG4gIGNvbnN0IHByb3hpZXMgPSBBcnJheS5pc0FycmF5KHByb3h5U2V0dGluZ3MpID8gcHJveHlTZXR0aW5ncyA6IFtwcm94eVNldHRpbmdzXTtcbiAgY29uc3QgY3JlYXRlZFByb3hpZXMgPSBbXTtcblxuICBmb3IgKGNvbnN0IHByb3h5IG9mIHByb3hpZXMpIHtcbiAgICBmb3IgKGNvbnN0IFtrZXksIGNvbnRleHRdIG9mIE9iamVjdC5lbnRyaWVzKHByb3h5KSkge1xuICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNyZWF0ZWRQcm94aWVzLnB1c2goXG4gICAgICAgICAgY3JlYXRlUHJveHlNaWRkbGV3YXJlKFxuICAgICAgICAgICAga2V5LnJlcGxhY2UoL15cXCokLywgJyoqJykucmVwbGFjZSgvXFwvXFwqJC8sICcnKSxcbiAgICAgICAgICAgIGNvbnRleHQgYXMgYW55LFxuICAgICAgICAgICkgYXMgYnJvd3NlclN5bmMuTWlkZGxld2FyZUhhbmRsZXIsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjcmVhdGVkUHJveGllcy5wdXNoKFxuICAgICAgICAgIGNyZWF0ZVByb3h5TWlkZGxld2FyZShrZXksIGNvbnRleHQgYXMgYW55KSBhcyBicm93c2VyU3luYy5NaWRkbGV3YXJlSGFuZGxlcixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gY3JlYXRlZFByb3hpZXM7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNyZWF0ZUJ1aWxkZXI8U1NSRGV2U2VydmVyQnVpbGRlck9wdGlvbnMsIEJ1aWxkZXJPdXRwdXQ+KGV4ZWN1dGUpO1xuIl19